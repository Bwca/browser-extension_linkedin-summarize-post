<div class="settings-container">
  <div class="header">
    <a routerLink="/about" class="about-btn">‚ÑπÔ∏è About</a>
    <h1>AI Settings Profiles</h1>
  </div>

  @if (loading()) {
  <div class="loading-state">
    <p>Loading profiles...</p>
  </div>
  } @else {
  <!-- Profiles List -->
  <div class="profiles-section">
    <div class="section-header">
      <h2>Your Profiles</h2>
      <button type="button" class="btn btn-primary" (click)="startAddProfile()">
        + Add Profile
      </button>
    </div>

    <div class="profiles-list">
      @for (profile of sortedProfiles(); track profile.id) {
      <div class="profile-card" [class.active]="isProfileActive(profile)">
        <div class="profile-header">
          <h3>{{ profile.name }}</h3>
          <div class="profile-meta-inline">
            <span class="meta-item-inline"
              >Temp: {{ profile.settings.temperature.toFixed(1) }}</span
            >
            <span class="meta-item-inline">Top K: {{ profile.settings.topK }}</span>
          </div>
          @if (isProfileActive(profile)) {
          <span class="active-badge">Active</span>
          }
        </div>

        <div class="profile-actions">
          @if (!isProfileActive(profile)) {
          <button
            type="button"
            class="btn-profile btn-outline"
            (click)="previewProfileSettings(profile)"
          >
            üëÅÔ∏è Preview
          </button>
          <button
            type="button"
            class="btn-profile btn-primary"
            (click)="switchToProfile(profile.id)"
          >
            Switch To
          </button>
          }
          <button type="button" class="btn-profile btn-outline" (click)="startEditProfile(profile)">
            ‚úèÔ∏è Edit
          </button>
          <button type="button" class="btn-profile btn-outline" (click)="duplicateProfile(profile)">
            üìã Duplicate
          </button>
          @if (profiles().length > 1) {
          <button
            type="button"
            class="btn-profile btn-danger"
            (click)="confirmDeleteProfile(profile)"
          >
            üóëÔ∏è Delete
          </button>
          }
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Quick Edit Active Profile -->
  @if (activeProfile()) {
  <details class="active-profile-section">
    <summary class="section-header">
      <h2>Edit Active Profile: {{ activeProfile()!.name }}</h2>
    </summary>

    <form [formGroup]="settingsForm" (ngSubmit)="onSave()" class="settings-form">
      <div class="form-group">
        <label for="temperature">
          Temperature
          <span class="help-text">Controls randomness (0.0 - 1.0)</span>
        </label>
        <div class="input-group">
          <input
            type="range"
            id="temperature"
            formControlName="temperature"
            min="0"
            max="1"
            step="0.1"
          />
          <span class="value-display">{{
            settingsForm.get('temperature')?.value?.toFixed(1)
          }}</span>
        </div>
        <p class="description">
          Higher values (0.8-1.0) make output more creative and varied. Lower values (0.0-0.3) make
          it more focused and deterministic.
        </p>
      </div>

      <div class="form-group">
        <label for="topK">
          Top K
          <span class="help-text">Limits vocabulary selection</span>
        </label>
        <div class="input-group">
          <input type="range" id="topK" formControlName="topK" min="1" max="10" step="1" />
          <span class="value-display">{{ settingsForm.get('topK')?.value }}</span>
        </div>
        <p class="description">
          Lower values (1-3) make output more focused. Higher values (8-10) allow more diverse
          vocabulary.
        </p>
      </div>

      <div class="form-group">
        <label for="systemPrompt">
          System Prompt
          <span class="help-text">Instructions for the AI</span>
        </label>
        <textarea
          id="systemPrompt"
          formControlName="systemPrompt"
          rows="12"
          class="prompt-textarea"
        ></textarea>
        <button type="button" class="btn-link" (click)="resetPromptToDefault()">
          Reset prompt to default
        </button>
        <p class="description">
          Customize how the AI analyzes LinkedIn posts. Changes take effect after saving.
        </p>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="saving()">
          {{ saving() ? 'Saving...' : 'Save Changes' }}
        </button>
      </div>
    </form>
  </details>
  } }

  <!-- Preview Modal -->
  @if (previewProfile) {
  <div class="modal-overlay" (click)="closePreview()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Preview: {{ previewProfile.name }}</h3>
        <button type="button" class="modal-close" (click)="closePreview()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="preview-settings">
          <div class="setting-item">
            <strong>Temperature:</strong> {{ previewProfile.settings.temperature.toFixed(1) }}
          </div>
          <div class="setting-item"><strong>Top K:</strong> {{ previewProfile.settings.topK }}</div>
          <div class="setting-item">
            <strong>System Prompt:</strong>
            <pre class="prompt-preview">{{ previewProfile.settings.systemPrompt }}</pre>
          </div>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-primary"
            (click)="switchToProfile(previewProfile.id); closePreview()"
          >
            Switch to This Profile
          </button>
          <button type="button" class="btn btn-secondary" (click)="closePreview()">Close</button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Add Profile Modal -->
  @if (showAddProfile()) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Profile</h3>
        <button type="button" class="modal-close" (click)="cancelAddProfile()">√ó</button>
      </div>
      <form [formGroup]="profileForm" (ngSubmit)="saveNewProfile()" class="modal-body">
        <div class="form-group">
          <label for="newProfileName">Profile Name</label>
          <input
            type="text"
            id="newProfileName"
            formControlName="name"
            placeholder="Enter profile name"
          />
          @if (profileForm.get('name')?.invalid && profileForm.get('name')?.touched) {
          <div class="error-message">
            @if (profileForm.get('name')?.errors?.['required']) { Profile name is required } @if
            (profileForm.get('name')?.errors?.['minlength']) { Profile name must be at least 1
            character } @if (profileForm.get('name')?.errors?.['maxlength']) { Profile name cannot
            exceed 50 characters }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="newTemperature">Temperature</label>
          <div class="input-group">
            <input
              type="range"
              id="newTemperature"
              formControlName="temperature"
              min="0"
              max="1"
              step="0.1"
            />
            <span class="value-display">{{
              profileForm.get('temperature')?.value?.toFixed(1)
            }}</span>
          </div>
          @if (profileForm.get('temperature')?.invalid && profileForm.get('temperature')?.touched) {
          <div class="error-message">
            @if (profileForm.get('temperature')?.errors?.['required']) { Temperature is required }
            @if (profileForm.get('temperature')?.errors?.['min']) { Temperature must be at least 0 }
            @if (profileForm.get('temperature')?.errors?.['max']) { Temperature cannot exceed 1 }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="newTopK">Top K</label>
          <div class="input-group">
            <input type="range" id="newTopK" formControlName="topK" min="1" max="10" step="1" />
            <span class="value-display">{{ profileForm.get('topK')?.value }}</span>
          </div>
          @if (profileForm.get('topK')?.invalid && profileForm.get('topK')?.touched) {
          <div class="error-message">
            @if (profileForm.get('topK')?.errors?.['required']) { Top K is required } @if
            (profileForm.get('topK')?.errors?.['min']) { Top K must be at least 1 } @if
            (profileForm.get('topK')?.errors?.['max']) { Top K cannot exceed 10 }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="newSystemPrompt">System Prompt</label>
          <textarea
            id="newSystemPrompt"
            formControlName="systemPrompt"
            rows="10"
            class="prompt-textarea"
          ></textarea>
          @if (profileForm.get('systemPrompt')?.invalid && profileForm.get('systemPrompt')?.touched)
          {
          <div class="error-message">
            @if (profileForm.get('systemPrompt')?.errors?.['required']) { System prompt is required
            } @if (profileForm.get('systemPrompt')?.errors?.['minlength']) { System prompt must be
            at least 10 characters }
          </div>
          }
          <button type="button" class="btn-link" (click)="resetPromptToDefault()">
            Reset to default prompt
          </button>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            {{ saving() ? 'Creating...' : 'Create Profile' }}
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelAddProfile()"
            [disabled]="saving()"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Edit Profile Modal -->
  @if (showEditProfile() && currentEditingProfile()) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Profile: {{ currentEditingProfile()!.name }}</h3>
        <button type="button" class="modal-close" (click)="cancelEditProfile()">√ó</button>
      </div>
      <form [formGroup]="profileForm" (ngSubmit)="saveEditedProfile()" class="modal-body">
        <div class="form-group">
          <label for="editProfileName">Profile Name</label>
          <input
            type="text"
            id="editProfileName"
            formControlName="name"
            placeholder="Enter profile name"
          />
          @if (profileForm.get('name')?.invalid && profileForm.get('name')?.touched) {
          <div class="error-message">
            @if (profileForm.get('name')?.errors?.['required']) { Profile name is required } @if
            (profileForm.get('name')?.errors?.['minlength']) { Profile name must be at least 1
            character } @if (profileForm.get('name')?.errors?.['maxlength']) { Profile name cannot
            exceed 50 characters }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="editTemperature">Temperature</label>
          <div class="input-group">
            <input
              type="range"
              id="editTemperature"
              formControlName="temperature"
              min="0"
              max="1"
              step="0.1"
            />
            <span class="value-display">{{
              profileForm.get('temperature')?.value?.toFixed(1)
            }}</span>
          </div>
          @if (profileForm.get('temperature')?.invalid && profileForm.get('temperature')?.touched) {
          <div class="error-message">
            @if (profileForm.get('temperature')?.errors?.['required']) { Temperature is required }
            @if (profileForm.get('temperature')?.errors?.['min']) { Temperature must be at least 0 }
            @if (profileForm.get('temperature')?.errors?.['max']) { Temperature cannot exceed 1 }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="editTopK">Top K</label>
          <div class="input-group">
            <input type="range" id="editTopK" formControlName="topK" min="1" max="10" step="1" />
            <span class="value-display">{{ profileForm.get('topK')?.value }}</span>
          </div>
          @if (profileForm.get('topK')?.invalid && profileForm.get('topK')?.touched) {
          <div class="error-message">
            @if (profileForm.get('topK')?.errors?.['required']) { Top K is required } @if
            (profileForm.get('topK')?.errors?.['min']) { Top K must be at least 1 } @if
            (profileForm.get('topK')?.errors?.['max']) { Top K cannot exceed 10 }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="editSystemPrompt">System Prompt</label>
          <textarea
            id="editSystemPrompt"
            formControlName="systemPrompt"
            rows="10"
            class="prompt-textarea"
          ></textarea>
          @if (profileForm.get('systemPrompt')?.invalid && profileForm.get('systemPrompt')?.touched)
          {
          <div class="error-message">
            @if (profileForm.get('systemPrompt')?.errors?.['required']) { System prompt is required
            } @if (profileForm.get('systemPrompt')?.errors?.['minlength']) { System prompt must be
            at least 10 characters }
          </div>
          }
          <button type="button" class="btn-link" (click)="resetPromptToDefault()">
            Reset to default prompt
          </button>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            {{ saving() ? 'Saving...' : 'Save Changes' }}
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelEditProfile()"
            [disabled]="saving()"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteConfirm().profile) {
  <div class="modal-overlay">
    <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Delete Profile?</h3>
        <button type="button" class="modal-close" (click)="cancelDeleteProfile()">√ó</button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete the profile
          <strong>{{ showDeleteConfirm().profile?.name }}</strong
          >?
        </p>
        <p class="warning-text">This action cannot be undone.</p>
        <div class="modal-actions">
          <button
            type="button"
            class="btn btn-danger"
            (click)="deleteProfile()"
            [disabled]="saving()"
          >
            {{ saving() ? 'Deleting...' : 'Yes, Delete' }}
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelDeleteProfile()"
            [disabled]="saving()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Messages -->
  @if (message()) {
  <div class="message" [class.error]="isError()">
    {{ message() }}
  </div>
  }

  <!-- Info Box -->
  <div class="info-box">
    <h3>üí° Tips</h3>
    <ul>
      <li><strong>Temperature 0.8 + Top K 3</strong> (default): Balanced, consistent analysis</li>
      <li><strong>Temperature 0.3 + Top K 1</strong>: Very consistent, predictable results</li>
      <li><strong>Temperature 1.0 + Top K 8</strong>: More creative, varied summaries</li>
    </ul>
    <p>
      <strong>üí° Profile Management:</strong> Create different profiles for different analysis
      styles. For example, one profile for "gentle" feedback and another for "ruthless" criticism.
    </p>
  </div>
</div>
